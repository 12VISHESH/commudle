<% content_for :page_title do %>
  <%= @kommunity.name %> | <%= @edfeg.event.name %> | <%= @edfeg.name %> Responses
<% end %>
<section class="container-fluid" id="data-form-entities-form-responses">
  <div>

    <div class="card">
      <div class="card-header">
        <%= @edfeg.event.name %> :: Responses :: <strong><%= @edfeg.name %></strong>
      </div>
      <div class="card-body">

        <div class="response-group-email-controls">
          <%= render 'group_email_controls', edfeg: @edfeg %>
        </div>

        <div class="mt-3">
          <ul class="list-group d-flex flex-row">

          <% @edfeg.data_form_entities.order('created_at').each do |dfe| %>
            <li class="list-group-item">
            <%= link_to 'On The Spot Registration', fill_form_response_path(data_form_entity_id: dfe, for_other_user: true, ots: true), class: 'ml-2 text-primary' %>
            </li>
            <li class="list-group-item">
              <%= link_to 'Attendance Page', auto_attendance_event_entry_passes_path(event: @edfeg.event), class: 'ml-2 text-primary' %>
            </li>
          <% end %>
          </ul>


        </div>

      </div>
    </div>



    <div class="table-responsive">
      <table class="table table-hover table-fixed">
        <thead>
        <tr>
          <th scope="col" class="sticky-row sticky-col">
            <p>#</p>
          </th>
          <th scope="col" class="sticky-row">
            <p>Name / Email</p>
          </th>
          <th scope="col" class="sticky-row">
            <p>
              Registration Status / Actions
            </p>
          </th>
          <% @edfeg.data_form_entities.each do |dfe| %>
          <%  dfe.data_form.questions.with_deleted.each do |question| %>
          <th scope="col" class="sticky-row">
            <p>
              <%= question.title %>
            </p>
          </th>
          <% end %>
          <% end %>

        </tr>

        </thead>
        <tbody>
        <!--TODO Optimize the query to show responses-->


        <% @edfeg.data_form_entity_response_groups.order(:created_at).each.with_index(1) do |dferg, index| %>
        <tr>
          <td class="pt-2 pb-0">
            <p>
              <%= index %>
            </p>
          </td>
          <th scope="row" class="pt-2 pb-0">
            <p class="mb-0">
              <%= dferg.user.name %>
            </p>
            <p>
              <%= dferg.user.email %>
            </p>
          </th>

          <td class="pt-2 pb-2 sticky-box">

            <% if(!@edfeg.registration_type.blank?) %>
            <%= render 'data_form_entity_response_groups/registration_status_actions', dferg: dferg, entry_pass: @entry_passes.select{|ep| ep.user == dferg.user && ep.event == @edfeg.event}.first %>
            <% end %>
          </td>
          <% @edfeg.data_form_entities.each do |dfe| %>
          <% dfe.data_form.questions.with_deleted.each do |question| %>
          <% dferg.data_form_entity_responses.each do |dfer| %>



          <td class="pt-2 pb-0">

            <p>
              <%= DataFormEntityResponseValue.get_response_text(question, dfer) %>
            </p>

          </td>


          <% end %>
          <% end %>
          <% end %>

          <td class="pt-2 pb-0">

          </td>
        </tr>

        <% end %>


        </tbody>

      </table>
    </div>




  </div>


</section>
